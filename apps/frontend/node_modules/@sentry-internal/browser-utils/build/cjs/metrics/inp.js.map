{"version":3,"file":"inp.js","sources":["../../../src/metrics/inp.ts"],"sourcesContent":["import type { Span, SpanAttributes } from '@sentry/core';\nimport {\n  SEMANTIC_ATTRIBUTE_EXCLUSIVE_TIME,\n  SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_UNIT,\n  SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_VALUE,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  browserPerformanceTimeOrigin,\n  dropUndefinedKeys,\n  getActiveSpan,\n  getCurrentScope,\n  getRootSpan,\n  htmlTreeAsString,\n  spanToJSON,\n} from '@sentry/core';\nimport {\n  addInpInstrumentationHandler,\n  addPerformanceInstrumentationHandler,\n  isPerformanceEventTiming,\n} from './instrument';\nimport { getBrowserPerformanceAPI, msToSec, startStandaloneWebVitalSpan } from './utils';\n\nconst LAST_INTERACTIONS: number[] = [];\nconst INTERACTIONS_SPAN_MAP = new Map<number, Span>();\n\n/**\n * Start tracking INP webvital events.\n */\nexport function startTrackingINP(): () => void {\n  const performance = getBrowserPerformanceAPI();\n  if (performance && browserPerformanceTimeOrigin) {\n    const inpCallback = _trackINP();\n\n    return (): void => {\n      inpCallback();\n    };\n  }\n\n  return () => undefined;\n}\n\nconst INP_ENTRY_MAP: Record<string, 'click' | 'hover' | 'drag' | 'press'> = {\n  click: 'click',\n  pointerdown: 'click',\n  pointerup: 'click',\n  mousedown: 'click',\n  mouseup: 'click',\n  touchstart: 'click',\n  touchend: 'click',\n  mouseover: 'hover',\n  mouseout: 'hover',\n  mouseenter: 'hover',\n  mouseleave: 'hover',\n  pointerover: 'hover',\n  pointerout: 'hover',\n  pointerenter: 'hover',\n  pointerleave: 'hover',\n  dragstart: 'drag',\n  dragend: 'drag',\n  drag: 'drag',\n  dragenter: 'drag',\n  dragleave: 'drag',\n  dragover: 'drag',\n  drop: 'drag',\n  keydown: 'press',\n  keyup: 'press',\n  keypress: 'press',\n  input: 'press',\n};\n\n/** Starts tracking the Interaction to Next Paint on the current page. */\nfunction _trackINP(): () => void {\n  return addInpInstrumentationHandler(({ metric }) => {\n    if (metric.value == undefined) {\n      return;\n    }\n\n    const entry = metric.entries.find(entry => entry.duration === metric.value && INP_ENTRY_MAP[entry.name]);\n\n    if (!entry) {\n      return;\n    }\n\n    const { interactionId } = entry;\n    const interactionType = INP_ENTRY_MAP[entry.name];\n\n    /** Build the INP span, create an envelope from the span, and then send the envelope */\n    const startTime = msToSec((browserPerformanceTimeOrigin as number) + entry.startTime);\n    const duration = msToSec(metric.value);\n    const activeSpan = getActiveSpan();\n    const rootSpan = activeSpan ? getRootSpan(activeSpan) : undefined;\n\n    // We first try to lookup the span from our INTERACTIONS_SPAN_MAP,\n    // where we cache the route per interactionId\n    const cachedSpan = interactionId != null ? INTERACTIONS_SPAN_MAP.get(interactionId) : undefined;\n\n    const spanToUse = cachedSpan || rootSpan;\n\n    // Else, we try to use the active span.\n    // Finally, we fall back to look at the transactionName on the scope\n    const routeName = spanToUse ? spanToJSON(spanToUse).description : getCurrentScope().getScopeData().transactionName;\n\n    const name = htmlTreeAsString(entry.target);\n    const attributes: SpanAttributes = dropUndefinedKeys({\n      [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.http.browser.inp',\n      [SEMANTIC_ATTRIBUTE_SENTRY_OP]: `ui.interaction.${interactionType}`,\n      [SEMANTIC_ATTRIBUTE_EXCLUSIVE_TIME]: entry.duration,\n    });\n\n    const span = startStandaloneWebVitalSpan({\n      name,\n      transaction: routeName,\n      attributes,\n      startTime,\n    });\n\n    if (span) {\n      span.addEvent('inp', {\n        [SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_UNIT]: 'millisecond',\n        [SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_VALUE]: metric.value,\n      });\n\n      span.end(startTime + duration);\n    }\n  });\n}\n\n/**\n * Register a listener to cache route information for INP interactions.\n * TODO(v9): `latestRoute` no longer needs to be passed in and will be removed in v9.\n */\nexport function registerInpInteractionListener(_latestRoute?: unknown): void {\n  const handleEntries = ({ entries }: { entries: PerformanceEntry[] }): void => {\n    const activeSpan = getActiveSpan();\n    const activeRootSpan = activeSpan && getRootSpan(activeSpan);\n\n    entries.forEach(entry => {\n      if (!isPerformanceEventTiming(entry) || !activeRootSpan) {\n        return;\n      }\n\n      const interactionId = entry.interactionId;\n      if (interactionId == null) {\n        return;\n      }\n\n      // If the interaction was already recorded before, nothing more to do\n      if (INTERACTIONS_SPAN_MAP.has(interactionId)) {\n        return;\n      }\n\n      // We keep max. 10 interactions in the list, then remove the oldest one & clean up\n      if (LAST_INTERACTIONS.length > 10) {\n        const last = LAST_INTERACTIONS.shift() as number;\n        INTERACTIONS_SPAN_MAP.delete(last);\n      }\n\n      // We add the interaction to the list of recorded interactions\n      // and store the span for this interaction\n      LAST_INTERACTIONS.push(interactionId);\n      INTERACTIONS_SPAN_MAP.set(interactionId, activeRootSpan);\n    });\n  };\n\n  addPerformanceInstrumentationHandler('event', handleEntries);\n  addPerformanceInstrumentationHandler('first-input', handleEntries);\n}\n"],"names":["getBrowserPerformanceAPI","browserPerformanceTimeOrigin","addInpInstrumentationHandler","msToSec","getActiveSpan","getRootSpan","spanToJSON","getCurrentScope","htmlTreeAsString","dropUndefinedKeys","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","SEMANTIC_ATTRIBUTE_SENTRY_OP","SEMANTIC_ATTRIBUTE_EXCLUSIVE_TIME","startStandaloneWebVitalSpan","SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_UNIT","SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_VALUE","isPerformanceEventTiming","addPerformanceInstrumentationHandler"],"mappings":"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"}