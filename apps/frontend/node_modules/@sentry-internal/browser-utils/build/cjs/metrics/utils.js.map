{"version":3,"file":"utils.js","sources":["../../../src/metrics/utils.ts"],"sourcesContent":["import type { Integration, SentrySpan, Span, SpanAttributes, SpanTimeInput, StartSpanOptions } from '@sentry/core';\nimport { getClient, getCurrentScope, spanToJSON, startInactiveSpan, withActiveSpan } from '@sentry/core';\nimport { WINDOW } from '../types';\n\n/**\n * Checks if a given value is a valid measurement value.\n */\nexport function isMeasurementValue(value: unknown): value is number {\n  return typeof value === 'number' && isFinite(value);\n}\n\n/**\n * Helper function to start child on transactions. This function will make sure that the transaction will\n * use the start timestamp of the created child span if it is earlier than the transactions actual\n * start timestamp.\n */\nexport function startAndEndSpan(\n  parentSpan: Span,\n  startTimeInSeconds: number,\n  endTime: SpanTimeInput,\n  { ...ctx }: StartSpanOptions,\n): Span | undefined {\n  const parentStartTime = spanToJSON(parentSpan).start_timestamp;\n  if (parentStartTime && parentStartTime > startTimeInSeconds) {\n    // We can only do this for SentrySpans...\n    if (typeof (parentSpan as Partial<SentrySpan>).updateStartTime === 'function') {\n      (parentSpan as SentrySpan).updateStartTime(startTimeInSeconds);\n    }\n  }\n\n  // The return value only exists for tests\n  return withActiveSpan(parentSpan, () => {\n    const span = startInactiveSpan({\n      startTime: startTimeInSeconds,\n      ...ctx,\n    });\n\n    if (span) {\n      span.end(endTime);\n    }\n\n    return span;\n  });\n}\n\ninterface StandaloneWebVitalSpanOptions {\n  name: string;\n  transaction?: string;\n  attributes: SpanAttributes;\n  startTime: number;\n}\n\n/**\n * Starts an inactive, standalone span used to send web vital values to Sentry.\n * DO NOT use this for arbitrary spans, as these spans require special handling\n * during ingestion to extract metrics.\n *\n * This function adds a bunch of attributes and data to the span that's shared\n * by all web vital standalone spans. However, you need to take care of adding\n * the actual web vital value as an event to the span. Also, you need to assign\n * a transaction name and some other values that are specific to the web vital.\n *\n * Ultimately, you also need to take care of ending the span to send it off.\n *\n * @param options\n *\n * @returns an inactive, standalone and NOT YET ended span\n */\nexport function startStandaloneWebVitalSpan(options: StandaloneWebVitalSpanOptions): Span | undefined {\n  const client = getClient();\n  if (!client) {\n    return;\n  }\n\n  const { name, transaction, attributes: passedAttributes, startTime } = options;\n\n  const { release, environment } = client.getOptions();\n  // We need to get the replay, user, and activeTransaction from the current scope\n  // so that we can associate replay id, profile id, and a user display to the span\n  const replay = client.getIntegrationByName<Integration & { getReplayId: () => string }>('Replay');\n  const replayId = replay && replay.getReplayId();\n\n  const scope = getCurrentScope();\n\n  const user = scope.getUser();\n  const userDisplay = user !== undefined ? user.email || user.id || user.ip_address : undefined;\n\n  let profileId: string | undefined;\n  try {\n    // @ts-expect-error skip optional chaining to save bundle size with try catch\n    profileId = scope.getScopeData().contexts.profile.profile_id;\n  } catch {\n    // do nothing\n  }\n\n  const attributes: SpanAttributes = {\n    release,\n    environment,\n\n    user: userDisplay || undefined,\n    profile_id: profileId || undefined,\n    replay_id: replayId || undefined,\n\n    transaction,\n\n    // Web vital score calculation relies on the user agent to account for different\n    // browsers setting different thresholds for what is considered a good/meh/bad value.\n    // For example: Chrome vs. Chrome Mobile\n    'user_agent.original': WINDOW.navigator && WINDOW.navigator.userAgent,\n\n    ...passedAttributes,\n  };\n\n  return startInactiveSpan({\n    name,\n    attributes,\n    startTime,\n    experimental: {\n      standalone: true,\n    },\n  });\n}\n\n/** Get the browser performance API. */\nexport function getBrowserPerformanceAPI(): Performance | undefined {\n  // @ts-expect-error we want to make sure all of these are available, even if TS is sure they are\n  return WINDOW && WINDOW.addEventListener && WINDOW.performance;\n}\n\n/**\n * Converts from milliseconds to seconds\n * @param time time in ms\n */\nexport function msToSec(time: number): number {\n  return time / 1000;\n}\n\n/**\n * Converts ALPN protocol ids to name and version.\n *\n * (https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml#alpn-protocol-ids)\n * @param nextHopProtocol PerformanceResourceTiming.nextHopProtocol\n */\nexport function extractNetworkProtocol(nextHopProtocol: string): { name: string; version: string } {\n  let name = 'unknown';\n  let version = 'unknown';\n  let _name = '';\n  for (const char of nextHopProtocol) {\n    // http/1.1 etc.\n    if (char === '/') {\n      [name, version] = nextHopProtocol.split('/') as [string, string];\n      break;\n    }\n    // h2, h3 etc.\n    if (!isNaN(Number(char))) {\n      name = _name === 'h' ? 'http' : _name;\n      version = nextHopProtocol.split(_name)[1] as string;\n      break;\n    }\n    _name += char;\n  }\n  if (_name === nextHopProtocol) {\n    // webrtc, ftp, etc.\n    name = _name;\n  }\n  return { name, version };\n}\n"],"names":["spanToJSON","withActiveSpan","startInactiveSpan","getClient","getCurrentScope","WINDOW"],"mappings":"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"}