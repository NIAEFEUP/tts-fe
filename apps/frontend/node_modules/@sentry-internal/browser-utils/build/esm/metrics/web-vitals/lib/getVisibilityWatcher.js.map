{"version":3,"file":"getVisibilityWatcher.js","sources":["../../../../../src/metrics/web-vitals/lib/getVisibilityWatcher.ts"],"sourcesContent":["/*\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { WINDOW } from '../../../types';\n\nlet firstHiddenTime = -1;\n\nconst initHiddenTime = () => {\n  // If the document is hidden when this code runs, assume it was always\n  // hidden and the page was loaded in the background, with the one exception\n  // that visibility state is always 'hidden' during prerendering, so we have\n  // to ignore that case until prerendering finishes (see: `prerenderingchange`\n  // event logic below).\n  return WINDOW.document!.visibilityState === 'hidden' && !WINDOW.document!.prerendering ? 0 : Infinity;\n};\n\nconst onVisibilityUpdate = (event: Event) => {\n  // If the document is 'hidden' and no previous hidden timestamp has been\n  // set, update it based on the current event data.\n  if (WINDOW.document!.visibilityState === 'hidden' && firstHiddenTime > -1) {\n    // If the event is a 'visibilitychange' event, it means the page was\n    // visible prior to this change, so the event timestamp is the first\n    // hidden time.\n    // However, if the event is not a 'visibilitychange' event, then it must\n    // be a 'prerenderingchange' event, and the fact that the document is\n    // still 'hidden' from the above check means the tab was activated\n    // in a background state and so has always been hidden.\n    firstHiddenTime = event.type === 'visibilitychange' ? event.timeStamp : 0;\n\n    // Remove all listeners now that a `firstHiddenTime` value has been set.\n    removeChangeListeners();\n  }\n};\n\nconst addChangeListeners = () => {\n  addEventListener('visibilitychange', onVisibilityUpdate, true);\n  // IMPORTANT: when a page is prerendering, its `visibilityState` is\n  // 'hidden', so in order to account for cases where this module checks for\n  // visibility during prerendering, an additional check after prerendering\n  // completes is also required.\n  addEventListener('prerenderingchange', onVisibilityUpdate, true);\n};\n\nconst removeChangeListeners = () => {\n  removeEventListener('visibilitychange', onVisibilityUpdate, true);\n  removeEventListener('prerenderingchange', onVisibilityUpdate, true);\n};\n\nexport const getVisibilityWatcher = () => {\n  if (WINDOW.document && firstHiddenTime < 0) {\n    // If the document is hidden when this code runs, assume it was hidden\n    // since navigation start. This isn't a perfect heuristic, but it's the\n    // best we can do until an API is available to support querying past\n    // visibilityState.\n    firstHiddenTime = initHiddenTime();\n    addChangeListeners();\n  }\n  return {\n    get firstHiddenTime() {\n      return firstHiddenTime;\n    },\n  };\n};\n"],"names":[],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAIA,IAAI,eAAA,GAAkB,CAAC,CAAC;;AAExB,MAAM,cAAe,GAAE,MAAM;AAC7B;AACA;AACA;AACA;AACA;AACA,EAAE,OAAO,MAAM,CAAC,QAAQ,CAAE,eAAA,KAAoB,QAAS,IAAG,CAAC,MAAM,CAAC,QAAQ,CAAE,eAAe,CAAA,GAAI,QAAQ;AACvG,CAAC;;AAED,MAAM,kBAAmB,GAAE,CAAC,KAAK,KAAY;AAC7C;AACA;AACA,EAAE,IAAI,MAAM,CAAC,QAAQ,CAAE,eAAA,KAAoB,QAAA,IAAY,eAAA,GAAkB,CAAC,CAAC,EAAE;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,eAAgB,GAAE,KAAK,CAAC,IAAK,KAAI,kBAAmB,GAAE,KAAK,CAAC,SAAU,GAAE,CAAC;;AAE7E;AACA,IAAI,qBAAqB,EAAE;AAC3B;AACA,CAAC;;AAED,MAAM,kBAAmB,GAAE,MAAM;AACjC,EAAE,gBAAgB,CAAC,kBAAkB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AAChE;AACA;AACA;AACA;AACA,EAAE,gBAAgB,CAAC,oBAAoB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AAClE,CAAC;;AAED,MAAM,qBAAsB,GAAE,MAAM;AACpC,EAAE,mBAAmB,CAAC,kBAAkB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AACnE,EAAE,mBAAmB,CAAC,oBAAoB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AACrE,CAAC;;AAEY,MAAA,oBAAA,GAAuB,MAAM;AAC1C,EAAE,IAAI,MAAM,CAAC,YAAY,eAAA,GAAkB,CAAC,EAAE;AAC9C;AACA;AACA;AACA;AACA,IAAI,eAAgB,GAAE,cAAc,EAAE;AACtC,IAAI,kBAAkB,EAAE;AACxB;AACA,EAAE,OAAO;AACT,IAAI,IAAI,eAAe,GAAG;AAC1B,MAAM,OAAO,eAAe;AAC5B,KAAK;AACL,GAAG;AACH;;;;"}