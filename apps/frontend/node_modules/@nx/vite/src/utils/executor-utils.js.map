{"version":3,"sources":["../../../../../packages/vite/src/utils/executor-utils.ts"],"sourcesContent":["import { ViteBuildExecutorOptions } from '../executors/build/schema';\nimport { ExecutorContext, getPackageManagerCommand } from '@nx/devkit';\nimport { ViteDevServerExecutorOptions } from '../executors/dev-server/schema';\nimport {\n  calculateProjectBuildableDependencies,\n  createTmpTsConfig,\n} from '@nx/js/src/utils/buildable-libs-utils';\nimport { getProjectTsConfigPath } from './options-utils';\nimport { execSync } from 'node:child_process';\nimport { printDiagnostics, runTypeCheck } from '@nx/js';\nimport { join } from 'path';\n\nexport async function validateTypes(opts: {\n  workspaceRoot: string;\n  tsconfig: string;\n  isVueProject?: boolean;\n}): Promise<void> {\n  if (!opts.isVueProject) {\n    const result = await runTypeCheck({\n      workspaceRoot: opts.workspaceRoot,\n      tsConfigPath: opts.tsconfig.startsWith(opts.workspaceRoot)\n        ? opts.tsconfig\n        : join(opts.workspaceRoot, opts.tsconfig),\n      mode: 'noEmit',\n    });\n\n    await printDiagnostics(result.errors, result.warnings);\n\n    if (result.errors.length > 0) {\n      throw new Error('Found type errors. See above.');\n    }\n  } else {\n    const pm = getPackageManagerCommand();\n    const cp = execSync(\n      `${pm.exec} vue-tsc --noEmit -p ${opts.tsconfig} --composite false`,\n      {\n        cwd: opts.workspaceRoot,\n        stdio: 'inherit',\n        windowsHide: false,\n      }\n    );\n  }\n}\n\nexport function createBuildableTsConfig(\n  projectRoot: string,\n  options: { tsConfig?: string; buildLibsFromSource?: boolean },\n  context: ExecutorContext\n) {\n  const tsConfig = options.tsConfig ?? getProjectTsConfigPath(projectRoot);\n  options['buildLibsFromSource'] ??= true;\n\n  if (!options['buildLibsFromSource']) {\n    const { dependencies } = calculateProjectBuildableDependencies(\n      context.taskGraph,\n      context.projectGraph,\n      context.root,\n      context.projectName,\n      // When using incremental building and the serve target is called\n      // we need to get the deps for the 'build' target instead.\n      context.targetName === 'serve' ? 'build' : context.targetName,\n      context.configurationName\n    );\n    // This tsconfig is used via the Vite ts paths plugin.\n    // It can be also used by other user-defined Vite plugins (e.g. for creating type declaration files).\n    const tmpTsConfigPath = createTmpTsConfig(\n      tsConfig,\n      context.root,\n      projectRoot,\n      dependencies\n    );\n    process.env.NX_TSCONFIG_PATH = tmpTsConfigPath;\n    return tmpTsConfigPath;\n  }\n  return tsConfig;\n}\n\nexport function loadViteDynamicImport() {\n  return Function('return import(\"vite\")')() as Promise<typeof import('vite')>;\n}\n\nexport function loadVitestDynamicImport() {\n  return Function('return import(\"vitest/node\")')() as Promise<\n    typeof import('vitest/node')\n  >;\n}\n"],"names":["createBuildableTsConfig","loadViteDynamicImport","loadVitestDynamicImport","validateTypes","opts","isVueProject","result","runTypeCheck","workspaceRoot","tsConfigPath","tsconfig","startsWith","join","mode","printDiagnostics","errors","warnings","length","Error","pm","getPackageManagerCommand","cp","execSync","exec","cwd","stdio","windowsHide","projectRoot","options","context","tsConfig","getProjectTsConfigPath","dependencies","calculateProjectBuildableDependencies","taskGraph","projectGraph","root","projectName","targetName","configurationName","tmpTsConfigPath","createTmpTsConfig","process","env","NX_TSCONFIG_PATH","Function"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;IA4CgBA,uBAAuB;eAAvBA;;IAiCAC,qBAAqB;eAArBA;;IAIAC,uBAAuB;eAAvBA;;IArEMC,aAAa;eAAbA;;;wBAXoC;oCAKnD;8BACgC;mCACd;oBACsB;sBAC1B;AAEd,eAAeA,cAAcC,IAInC;IACC,IAAI,CAACA,KAAKC,YAAY,EAAE;QACtB,MAAMC,SAAS,MAAMC,IAAAA,gBAAY,EAAC;YAChCC,eAAeJ,KAAKI,aAAa;YACjCC,cAAcL,KAAKM,QAAQ,CAACC,UAAU,CAACP,KAAKI,aAAa,IACrDJ,KAAKM,QAAQ,GACbE,IAAAA,UAAI,EAACR,KAAKI,aAAa,EAAEJ,KAAKM,QAAQ;YAC1CG,MAAM;QACR;QAEA,MAAMC,IAAAA,oBAAgB,EAACR,OAAOS,MAAM,EAAET,OAAOU,QAAQ;QAErD,IAAIV,OAAOS,MAAM,CAACE,MAAM,GAAG,GAAG;YAC5B,MAAM,IAAIC,MAAM;QAClB;IACF,OAAO;QACL,MAAMC,KAAKC,IAAAA,gCAAwB;QACnC,MAAMC,KAAKC,IAAAA,2BAAQ,EACjB,CAAC,EAAEH,GAAGI,IAAI,CAAC,qBAAqB,EAAEnB,KAAKM,QAAQ,CAAC,kBAAkB,CAAC,EACnE;YACEc,KAAKpB,KAAKI,aAAa;YACvBiB,OAAO;YACPC,aAAa;QACf;IAEJ;AACF;AAEO,SAAS1B,wBACd2B,WAAmB,EACnBC,OAA6D,EAC7DC,OAAwB;QAGxBD,UAAQ;QADSA;IAAjB,MAAME,WAAWF,CAAAA,oBAAAA,QAAQE,QAAQ,YAAhBF,oBAAoBG,IAAAA,oCAAsB,EAACJ;;IAC5DC,MAAAA,WAAAA,QAAO,CAAC,uBAAA,sBAAsB,gBAA9BA,QAAO,CAAC,qBAAsB,GAAK;IAEnC,IAAI,CAACA,OAAO,CAAC,sBAAsB,EAAE;QACnC,MAAM,EAAEI,YAAY,EAAE,GAAGC,IAAAA,yDAAqC,EAC5DJ,QAAQK,SAAS,EACjBL,QAAQM,YAAY,EACpBN,QAAQO,IAAI,EACZP,QAAQQ,WAAW,EACnB,iEAAiE;QACjE,0DAA0D;QAC1DR,QAAQS,UAAU,KAAK,UAAU,UAAUT,QAAQS,UAAU,EAC7DT,QAAQU,iBAAiB;QAE3B,sDAAsD;QACtD,qGAAqG;QACrG,MAAMC,kBAAkBC,IAAAA,qCAAiB,EACvCX,UACAD,QAAQO,IAAI,EACZT,aACAK;QAEFU,QAAQC,GAAG,CAACC,gBAAgB,GAAGJ;QAC/B,OAAOA;IACT;IACA,OAAOV;AACT;AAEO,SAAS7B;IACd,OAAO4C,SAAS;AAClB;AAEO,SAAS3C;IACd,OAAO2C,SAAS;AAGlB"}