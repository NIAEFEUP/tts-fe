{"version":3,"sources":["../../../../../../../packages/vite/src/generators/convert-to-inferred/lib/serve-post-target-transformer.ts"],"sourcesContent":["import { type TargetConfiguration, type Tree } from '@nx/devkit';\nimport { getViteConfigPath } from './utils';\nimport { AggregatedLog } from '@nx/devkit/src/generators/plugin-migrations/aggregate-log-util';\n\nexport function servePostTargetTransformer(migrationLogs: AggregatedLog) {\n  return (\n    target: TargetConfiguration,\n    tree: Tree,\n    projectDetails: { projectName: string; root: string },\n    inferredTargetConfiguration: TargetConfiguration\n  ) => {\n    const viteConfigPath = getViteConfigPath(tree, projectDetails.root);\n\n    if (target.options) {\n      removePropertiesFromTargetOptions(\n        tree,\n        target.options,\n        viteConfigPath,\n        projectDetails.root,\n        projectDetails.projectName,\n        migrationLogs,\n        true\n      );\n    }\n\n    if (target.configurations) {\n      for (const configurationName in target.configurations) {\n        const configuration = target.configurations[configurationName];\n        removePropertiesFromTargetOptions(\n          tree,\n          configuration,\n          viteConfigPath,\n          projectDetails.root,\n          projectDetails.projectName,\n          migrationLogs\n        );\n      }\n\n      if (Object.keys(target.configurations).length === 0) {\n        if ('defaultConfiguration' in target) {\n          delete target.defaultConfiguration;\n        }\n        delete target.configurations;\n      }\n\n      if (\n        'defaultConfiguration' in target &&\n        !target.configurations[target.defaultConfiguration]\n      ) {\n        delete target.defaultConfiguration;\n      }\n    }\n\n    return target;\n  };\n}\n\nfunction removePropertiesFromTargetOptions(\n  tree: Tree,\n  targetOptions: any,\n  viteConfigPath: string,\n  projectRoot: string,\n  projectName: string,\n  migrationLogs: AggregatedLog,\n  defaultOptions = false\n) {\n  if ('buildTarget' in targetOptions) {\n    delete targetOptions.buildTarget;\n  }\n\n  if ('buildLibsFromSource' in targetOptions) {\n    migrationLogs.addLog({\n      executorName: '@nx/vite:dev-server',\n      project: projectName,\n      log: `Encountered 'buildLibsFromSource' in project.json. This property will be added to your Vite config file via the '@nx/vite:build' executor migration.`,\n    });\n    delete targetOptions.buildLibsFromSource;\n  }\n\n  if ('hmr' in targetOptions) {\n    delete targetOptions.hmr;\n  }\n\n  if ('proxyConfig' in targetOptions) {\n    migrationLogs.addLog({\n      executorName: '@nx/vite:dev-server',\n      project: projectName,\n      log: `Encountered 'proxyConfig' in project.json. You will need to copy the contents of this file to the 'server.proxy' property in your Vite config file.`,\n    });\n    delete targetOptions.proxyConfig;\n  }\n}\n"],"names":["servePostTargetTransformer","migrationLogs","target","tree","projectDetails","inferredTargetConfiguration","viteConfigPath","getViteConfigPath","root","options","removePropertiesFromTargetOptions","projectName","configurations","configurationName","configuration","Object","keys","length","defaultConfiguration","targetOptions","projectRoot","defaultOptions","buildTarget","addLog","executorName","project","log","buildLibsFromSource","hmr","proxyConfig"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";+BAIgBA;;;eAAAA;;;uBAHkB;AAG3B,SAASA,2BAA2BC,aAA4B;IACrE,OAAO,CACLC,QACAC,MACAC,gBACAC;QAEA,MAAMC,iBAAiBC,IAAAA,wBAAiB,EAACJ,MAAMC,eAAeI,IAAI;QAElE,IAAIN,OAAOO,OAAO,EAAE;YAClBC,kCACEP,MACAD,OAAOO,OAAO,EACdH,gBACAF,eAAeI,IAAI,EACnBJ,eAAeO,WAAW,EAC1BV,eACA;QAEJ;QAEA,IAAIC,OAAOU,cAAc,EAAE;YACzB,IAAK,MAAMC,qBAAqBX,OAAOU,cAAc,CAAE;gBACrD,MAAME,gBAAgBZ,OAAOU,cAAc,CAACC,kBAAkB;gBAC9DH,kCACEP,MACAW,eACAR,gBACAF,eAAeI,IAAI,EACnBJ,eAAeO,WAAW,EAC1BV;YAEJ;YAEA,IAAIc,OAAOC,IAAI,CAACd,OAAOU,cAAc,EAAEK,MAAM,KAAK,GAAG;gBACnD,IAAI,0BAA0Bf,QAAQ;oBACpC,OAAOA,OAAOgB,oBAAoB;gBACpC;gBACA,OAAOhB,OAAOU,cAAc;YAC9B;YAEA,IACE,0BAA0BV,UAC1B,CAACA,OAAOU,cAAc,CAACV,OAAOgB,oBAAoB,CAAC,EACnD;gBACA,OAAOhB,OAAOgB,oBAAoB;YACpC;QACF;QAEA,OAAOhB;IACT;AACF;AAEA,SAASQ,kCACPP,IAAU,EACVgB,aAAkB,EAClBb,cAAsB,EACtBc,WAAmB,EACnBT,WAAmB,EACnBV,aAA4B,EAC5BoB,iBAAiB,KAAK;IAEtB,IAAI,iBAAiBF,eAAe;QAClC,OAAOA,cAAcG,WAAW;IAClC;IAEA,IAAI,yBAAyBH,eAAe;QAC1ClB,cAAcsB,MAAM,CAAC;YACnBC,cAAc;YACdC,SAASd;YACTe,KAAK,CAAC,oJAAoJ,CAAC;QAC7J;QACA,OAAOP,cAAcQ,mBAAmB;IAC1C;IAEA,IAAI,SAASR,eAAe;QAC1B,OAAOA,cAAcS,GAAG;IAC1B;IAEA,IAAI,iBAAiBT,eAAe;QAClClB,cAAcsB,MAAM,CAAC;YACnBC,cAAc;YACdC,SAASd;YACTe,KAAK,CAAC,mJAAmJ,CAAC;QAC5J;QACA,OAAOP,cAAcU,WAAW;IAClC;AACF"}