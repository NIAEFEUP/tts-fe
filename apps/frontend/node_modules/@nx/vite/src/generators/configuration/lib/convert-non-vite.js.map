{"version":3,"sources":["../../../../../../../packages/vite/src/generators/configuration/lib/convert-non-vite.ts"],"sourcesContent":["import {\n  TargetConfiguration,\n  Tree,\n  joinPathFragments,\n  logger,\n} from '@nx/devkit';\nimport {\n  findViteConfig,\n  findWebpackConfig,\n} from '../../../utils/find-vite-config';\nimport { ViteConfigurationGeneratorSchema } from '../schema';\nimport {\n  deleteWebpackConfig,\n  editTsConfig,\n  findExistingJsBuildTargetInProject,\n  handleUnknownConfiguration,\n  moveAndEditIndexHtml,\n} from '../../../utils/generator-utils';\nimport { getProjectType } from '@nx/js/src/utils/typescript/ts-solution-setup';\n\nexport async function convertNonVite(\n  tree: Tree,\n  schema: ViteConfigurationGeneratorSchema,\n  projectRoot: string,\n  _projectType: string,\n  targets: {\n    [targetName: string]: TargetConfiguration<any>;\n  }\n) {\n  // Check if it has vite\n  const hasViteConfig = findViteConfig(tree, projectRoot);\n  const hasIndexHtmlAtRoot = tree.exists(\n    joinPathFragments(projectRoot, 'index.html')\n  );\n\n  // Check if it has webpack\n  const hasWebpackConfig = findWebpackConfig(tree, projectRoot);\n  const projectType = getProjectType(\n    tree,\n    projectRoot,\n    _projectType as 'application' | 'library'\n  );\n  if (hasWebpackConfig) {\n    if (projectType === 'application') {\n      moveAndEditIndexHtml(tree, schema);\n    }\n    deleteWebpackConfig(tree, projectRoot, hasWebpackConfig);\n    editTsConfig(tree, schema);\n    return;\n  }\n\n  if (\n    projectType === 'application' &&\n    hasViteConfig &&\n    hasIndexHtmlAtRoot &&\n    !hasWebpackConfig\n  ) {\n    throw new Error(\n      `The project ${schema.project} is already configured to use Vite.`\n    );\n    return;\n  }\n\n  if (projectType === 'library' && hasViteConfig) {\n    // continue anyway - it could need to be updated - only update vite.config.ts in any case\n    editTsConfig(tree, schema);\n    return;\n  }\n\n  // Does the project have js executors?\n  const { supported: jsTargetName, unsupported } =\n    findExistingJsBuildTargetInProject(targets);\n  if (jsTargetName) {\n    editTsConfig(tree, schema);\n    return;\n  }\n\n  if (unsupported) {\n    throw new Error(`\n      Nx cannot convert your project to use vite.\n      Please try again with a different project.\n    `);\n  }\n\n  // If it's a library, it's most possible it's non-buildable\n  // So fix the tsconfig and return, to continue with the rest of the setup\n  if (\n    projectType === 'library' &&\n    !hasViteConfig &&\n    !hasWebpackConfig &&\n    !jsTargetName\n  ) {\n    editTsConfig(tree, schema);\n    return;\n  }\n\n  /**\n   * The project is an app.\n   * The project has no js executors, no webpack config, no vite config.\n   * We did not find any configuration that hints the project can\n   * definitely be converted.\n   * So, we should warn the user about it.\n   * They can choose whether to convert it or not\n   */\n  await handleUnknownConfiguration(schema.project);\n}\n"],"names":["convertNonVite","tree","schema","projectRoot","_projectType","targets","hasViteConfig","findViteConfig","hasIndexHtmlAtRoot","exists","joinPathFragments","hasWebpackConfig","findWebpackConfig","projectType","getProjectType","moveAndEditIndexHtml","deleteWebpackConfig","editTsConfig","Error","project","supported","jsTargetName","unsupported","findExistingJsBuildTargetInProject","handleUnknownConfiguration"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";+BAoBsBA;;;eAAAA;;;wBAff;gCAIA;gCAQA;iCACwB;AAExB,eAAeA,eACpBC,IAAU,EACVC,MAAwC,EACxCC,WAAmB,EACnBC,YAAoB,EACpBC,OAEC;IAED,uBAAuB;IACvB,MAAMC,gBAAgBC,IAAAA,8BAAc,EAACN,MAAME;IAC3C,MAAMK,qBAAqBP,KAAKQ,MAAM,CACpCC,IAAAA,yBAAiB,EAACP,aAAa;IAGjC,0BAA0B;IAC1B,MAAMQ,mBAAmBC,IAAAA,iCAAiB,EAACX,MAAME;IACjD,MAAMU,cAAcC,IAAAA,+BAAc,EAChCb,MACAE,aACAC;IAEF,IAAIO,kBAAkB;QACpB,IAAIE,gBAAgB,eAAe;YACjCE,IAAAA,oCAAoB,EAACd,MAAMC;QAC7B;QACAc,IAAAA,mCAAmB,EAACf,MAAME,aAAaQ;QACvCM,IAAAA,4BAAY,EAAChB,MAAMC;QACnB;IACF;IAEA,IACEW,gBAAgB,iBAChBP,iBACAE,sBACA,CAACG,kBACD;QACA,MAAM,IAAIO,MACR,CAAC,YAAY,EAAEhB,OAAOiB,OAAO,CAAC,mCAAmC,CAAC;QAEpE;IACF;IAEA,IAAIN,gBAAgB,aAAaP,eAAe;QAC9C,yFAAyF;QACzFW,IAAAA,4BAAY,EAAChB,MAAMC;QACnB;IACF;IAEA,sCAAsC;IACtC,MAAM,EAAEkB,WAAWC,YAAY,EAAEC,WAAW,EAAE,GAC5CC,IAAAA,kDAAkC,EAAClB;IACrC,IAAIgB,cAAc;QAChBJ,IAAAA,4BAAY,EAAChB,MAAMC;QACnB;IACF;IAEA,IAAIoB,aAAa;QACf,MAAM,IAAIJ,MAAM,CAAC;;;IAGjB,CAAC;IACH;IAEA,2DAA2D;IAC3D,yEAAyE;IACzE,IACEL,gBAAgB,aAChB,CAACP,iBACD,CAACK,oBACD,CAACU,cACD;QACAJ,IAAAA,4BAAY,EAAChB,MAAMC;QACnB;IACF;IAEA;;;;;;;GAOC,GACD,MAAMsB,IAAAA,0CAA0B,EAACtB,OAAOiB,OAAO;AACjD"}