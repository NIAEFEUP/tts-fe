{"version":3,"sources":["../../../../../../../packages/vite/src/migrations/update-17-2-0/lib/add-file-replacements.ts"],"sourcesContent":["import { ChangeType, applyChangesToString } from '@nx/devkit';\nimport { FileReplacement } from '../../../../plugins/rollup-replace-files.plugin';\nimport { tsquery } from '@phenomnomnominal/tsquery';\nimport { getConfigNode, notFoundWarning } from '../update-vite-config';\n\nexport function addFileReplacements(\n  configContents: string,\n  fileReplacements: FileReplacement[],\n  configPath: string\n): string {\n  const configNode = getConfigNode(configContents);\n  if (!configNode) {\n    notFoundWarning(configPath);\n    return configContents;\n  }\n  const pluginsObject = tsquery.query(\n    configNode,\n    `PropertyAssignment:has(Identifier[name=\"plugins\"])`\n  )?.[0];\n  const replaceFilesPlugin = tsquery.query(\n    configNode,\n    `PropertyAssignment:has(Identifier[name=\"plugins\"]) CallExpression:has(Identifier[name=\"replaceFiles\"])`\n  )?.[0];\n\n  const firstImportDeclaration = tsquery.query(\n    configContents,\n    'ImportDeclaration'\n  )?.[0];\n\n  if (pluginsObject) {\n    if (replaceFilesPlugin) {\n      return configContents;\n    } else {\n      return applyChangesToString(configContents, [\n        {\n          type: ChangeType.Insert,\n          index: pluginsObject.getStart() + `plugins: [`.length + 1,\n          text: `replaceFiles(${JSON.stringify(fileReplacements)}),`,\n        },\n        firstImportDeclaration\n          ? {\n              type: ChangeType.Insert,\n              index: firstImportDeclaration.getStart(),\n              text: `import replaceFiles from '@nx/vite/plugins/rollup-replace-files.plugin';\\n`,\n            }\n          : {\n              type: ChangeType.Insert,\n              index: 0,\n              text: `import replaceFiles from '@nx/vite/plugins/rollup-replace-files.plugin';\\n`,\n            },\n      ]);\n    }\n  } else {\n    const foundDefineConfig = tsquery.query(\n      configContents,\n      'CallExpression:has(Identifier[name=\"defineConfig\"])'\n    )?.[0];\n\n    if (!foundDefineConfig) {\n      return;\n    }\n    return applyChangesToString(configContents, [\n      {\n        type: ChangeType.Insert,\n        index: configNode.getStart() + 1,\n        text: `plugins: [replaceFiles(${JSON.stringify(fileReplacements)})],`,\n      },\n      firstImportDeclaration\n        ? {\n            type: ChangeType.Insert,\n            index: firstImportDeclaration.getStart(),\n            text: `import replaceFiles from '@nx/vite/plugins/rollup-replace-files.plugin';`,\n          }\n        : {\n            type: ChangeType.Insert,\n            index: 0,\n            text: `import replaceFiles from '@nx/vite/plugins/rollup-replace-files.plugin';`,\n          },\n    ]);\n  }\n}\n"],"names":["addFileReplacements","configContents","fileReplacements","configPath","tsquery","configNode","getConfigNode","notFoundWarning","pluginsObject","query","replaceFilesPlugin","firstImportDeclaration","applyChangesToString","type","ChangeType","Insert","index","getStart","length","text","JSON","stringify","foundDefineConfig"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";+BAKgBA;;;eAAAA;;;wBALiC;yBAEzB;kCACuB;AAExC,SAASA,oBACdC,cAAsB,EACtBC,gBAAmC,EACnCC,UAAkB;QAOIC,gBAIKA,iBAKIA;IAd/B,MAAMC,aAAaC,IAAAA,+BAAa,EAACL;IACjC,IAAI,CAACI,YAAY;QACfE,IAAAA,iCAAe,EAACJ;QAChB,OAAOF;IACT;IACA,MAAMO,iBAAgBJ,iBAAAA,gBAAO,CAACK,KAAK,CACjCJ,YACA,CAAC,kDAAkD,CAAC,sBAFhCD,cAGnB,CAAC,EAAE;IACN,MAAMM,sBAAqBN,kBAAAA,gBAAO,CAACK,KAAK,CACtCJ,YACA,CAAC,sGAAsG,CAAC,sBAF/ED,eAGxB,CAAC,EAAE;IAEN,MAAMO,0BAAyBP,kBAAAA,gBAAO,CAACK,KAAK,CAC1CR,gBACA,yCAF6BG,eAG5B,CAAC,EAAE;IAEN,IAAII,eAAe;QACjB,IAAIE,oBAAoB;YACtB,OAAOT;QACT,OAAO;YACL,OAAOW,IAAAA,4BAAoB,EAACX,gBAAgB;gBAC1C;oBACEY,MAAMC,kBAAU,CAACC,MAAM;oBACvBC,OAAOR,cAAcS,QAAQ,KAAK,CAAC,UAAU,CAAC,CAACC,MAAM,GAAG;oBACxDC,MAAM,CAAC,aAAa,EAAEC,KAAKC,SAAS,CAACnB,kBAAkB,EAAE,CAAC;gBAC5D;gBACAS,yBACI;oBACEE,MAAMC,kBAAU,CAACC,MAAM;oBACvBC,OAAOL,uBAAuBM,QAAQ;oBACtCE,MAAM,CAAC,0EAA0E,CAAC;gBACpF,IACA;oBACEN,MAAMC,kBAAU,CAACC,MAAM;oBACvBC,OAAO;oBACPG,MAAM,CAAC,0EAA0E,CAAC;gBACpF;aACL;QACH;IACF,OAAO;YACqBf;QAA1B,MAAMkB,qBAAoBlB,kBAAAA,gBAAO,CAACK,KAAK,CACrCR,gBACA,2EAFwBG,eAGvB,CAAC,EAAE;QAEN,IAAI,CAACkB,mBAAmB;YACtB;QACF;QACA,OAAOV,IAAAA,4BAAoB,EAACX,gBAAgB;YAC1C;gBACEY,MAAMC,kBAAU,CAACC,MAAM;gBACvBC,OAAOX,WAAWY,QAAQ,KAAK;gBAC/BE,MAAM,CAAC,uBAAuB,EAAEC,KAAKC,SAAS,CAACnB,kBAAkB,GAAG,CAAC;YACvE;YACAS,yBACI;gBACEE,MAAMC,kBAAU,CAACC,MAAM;gBACvBC,OAAOL,uBAAuBM,QAAQ;gBACtCE,MAAM,CAAC,wEAAwE,CAAC;YAClF,IACA;gBACEN,MAAMC,kBAAU,CAACC,MAAM;gBACvBC,OAAO;gBACPG,MAAM,CAAC,wEAAwE,CAAC;YAClF;SACL;IACH;AACF"}