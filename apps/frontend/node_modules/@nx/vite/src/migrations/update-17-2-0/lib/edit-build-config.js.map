{"version":3,"sources":["../../../../../../../packages/vite/src/migrations/update-17-2-0/lib/edit-build-config.ts"],"sourcesContent":["import {\n  ChangeType,\n  ProjectConfiguration,\n  Tree,\n  applyChangesToString,\n  joinPathFragments,\n  offsetFromRoot,\n  updateProjectConfiguration,\n} from '@nx/devkit';\nimport { tsquery } from '@phenomnomnominal/tsquery';\nimport ts = require('typescript');\nimport { getConfigNode, notFoundWarning } from '../update-vite-config';\n\nexport function updateBuildOutDirAndRoot(\n  options: Record<string, any>,\n  configContents: string,\n  projectConfig: ProjectConfiguration,\n  targetName: string,\n  tree: Tree,\n  projectName: string,\n  configPath: string\n): string {\n  const foundDefineConfig = tsquery.query(\n    configContents,\n    'CallExpression:has(Identifier[name=\"defineConfig\"])'\n  )?.[0];\n\n  if (!foundDefineConfig) {\n    notFoundWarning(configPath);\n    return;\n  }\n\n  configContents = fixBuild(\n    options,\n    configContents,\n    projectConfig,\n    targetName,\n    tree,\n    projectName,\n    configPath\n  );\n\n  configContents = addRoot(configContents, configPath);\n\n  return configContents;\n}\n\nfunction fixBuild(\n  options: Record<string, any>,\n  configContents: string,\n  projectConfig: ProjectConfiguration,\n  targetName: string,\n  tree: Tree,\n  projectName: string,\n  configPath: string\n) {\n  const configNode = getConfigNode(configContents);\n  if (!configNode) {\n    notFoundWarning(configPath);\n    return configContents;\n  }\n\n  let outputPath = '';\n\n  // In vite.config.ts, we want to keep the path relative to workspace root\n  if (options.outputPath) {\n    outputPath = joinPathFragments(\n      offsetFromRoot(projectConfig.root),\n      options.outputPath\n    );\n  } else {\n    outputPath = joinPathFragments(\n      offsetFromRoot(projectConfig.root),\n      'dist',\n      projectConfig.root\n    );\n  }\n\n  // In project.json, we want to keep the path starting from workspace root\n  projectConfig.targets[targetName].options.outputPath = options.outputPath\n    ? options.outputPath\n    : joinPathFragments('dist', projectConfig.root);\n  updateProjectConfiguration(tree, projectName, projectConfig);\n\n  const buildObject = tsquery.query(\n    configNode,\n    `PropertyAssignment:has(Identifier[name=\"build\"])`\n  )?.[0];\n\n  if (buildObject) {\n    const reportCompressedSizeExists =\n      tsquery.query(\n        buildObject,\n        `PropertyAssignment:has(Identifier[name=\"reportCompressedSize\"])`\n      )?.length > 0;\n\n    const commonjsOptionsExists =\n      tsquery.query(\n        buildObject,\n        `PropertyAssignment:has(Identifier[name=\"commonjsOptions\"])`\n      )?.length > 0;\n\n    const buildOutDir = tsquery.query(\n      buildObject,\n      `PropertyAssignment:has(Identifier[name=\"outDir\"])`\n    )?.length;\n\n    // Array to store changes\n    let changes = [];\n\n    // Add outDir if not present\n    if (!buildOutDir) {\n      changes.push({\n        type: ChangeType.Insert,\n        index: buildObject.getStart() + `build: {`.length + 1,\n        text: `outDir: '${outputPath}',`,\n      });\n    }\n\n    // Add reportCompressedSize if not present\n    if (!reportCompressedSizeExists) {\n      changes.push({\n        type: ChangeType.Insert,\n        index: buildObject.getStart() + `build: {`.length + 1,\n        text: `reportCompressedSize: true,`,\n      });\n    }\n\n    // Add commonjsOptions if not present\n    if (!commonjsOptionsExists) {\n      changes.push({\n        type: ChangeType.Insert,\n        index: buildObject.getStart() + `build: {`.length + 1,\n        text: `commonjsOptions: { transformMixedEsModules: true },`,\n      });\n    }\n\n    if (changes.length > 0) {\n      return applyChangesToString(configContents, changes);\n    }\n  } else {\n    return addBuildProperty(configContents, outputPath, configPath);\n  }\n\n  return configContents;\n}\n\nfunction addRoot(configFileContents: string, configPath: string): string {\n  const configNode = getConfigNode(configFileContents);\n\n  if (!configNode) {\n    notFoundWarning(configPath);\n    return configFileContents;\n  }\n\n  const rootOption = tsquery.query(\n    configNode,\n    `PropertyAssignment:has(Identifier[name=\"root\"]) Identifier[name=\"__dirname\"]`\n  )?.[0];\n\n  if (rootOption) {\n    return configFileContents;\n  } else {\n    return applyChangesToString(configFileContents, [\n      {\n        type: ChangeType.Insert,\n        index: configNode.getStart() + 1,\n        text: `root: __dirname,`,\n      },\n    ]);\n  }\n}\n\nfunction addBuildProperty(\n  configFileContents: string,\n  outputPath: string,\n  configPath: string\n): string {\n  const configNode = getConfigNode(configFileContents);\n  if (!configNode) {\n    notFoundWarning(configPath);\n    return configFileContents;\n  }\n\n  return applyChangesToString(configFileContents, [\n    {\n      type: ChangeType.Insert,\n      index: configNode.getStart() + 1,\n      text: `build: {\n                outDir: '${outputPath}',\n                reportCompressedSize: true,\n                commonjsOptions: {\n                  transformMixedEsModules: true,\n                },\n              },`,\n    },\n  ]);\n}\n"],"names":["updateBuildOutDirAndRoot","options","configContents","projectConfig","targetName","tree","projectName","configPath","tsquery","foundDefineConfig","query","notFoundWarning","fixBuild","addRoot","configNode","getConfigNode","outputPath","joinPathFragments","offsetFromRoot","root","targets","updateProjectConfiguration","buildObject","reportCompressedSizeExists","length","commonjsOptionsExists","buildOutDir","changes","push","type","ChangeType","Insert","index","getStart","text","applyChangesToString","addBuildProperty","configFileContents","rootOption"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}